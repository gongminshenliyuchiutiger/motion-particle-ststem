<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>炫彩粒子互動系統</title>
<style>
    :root {
        --c-cyan: #00f3ff; --c-fire: #ff5e00; --c-matrix: #39ff14;
        --c-ice: #00c3ff; --c-pink: #ff00ff; --c-dark: #020205;
        --c-panel: rgba(10, 15, 20, 0.9); --btn-clr: #fff;
    }
    body {
        margin: 0; background: var(--c-dark); color: #fff;
        font-family: 'Segoe UI', sans-serif; overflow: hidden;
        height: 100vh; user-select: none;
    }
    #mirror-container {
        position: absolute; inset: 0; transform: scaleX(-1); z-index: 1;
    }
    video, canvas {
        position: absolute; inset: 0; width: 100%; height: 100%;
    }
    video { object-fit: cover; opacity: 0; transition: opacity 0.5s; z-index: 1; }
    canvas { z-index: 2; }
    .grid-bg {
        position: absolute; inset: 0; z-index: 0;
        background-image: linear-gradient(#00f3ff08 1px, transparent 1px),
                          linear-gradient(90deg, #00f3ff08 1px, transparent 1px);
        background-size: 50px 50px; pointer-events: none;
    }
    #ui-layer {
        position: absolute; inset: 0; z-index: 10; pointer-events: none;
        display: flex; flex-direction: column; justify-content: space-between;
    }
    #top-controls {
        padding: 25px; display: flex; justify-content: center; gap: 8px;
        opacity: 0; transform: translateY(-20px); transition: 0.6s;
        background: linear-gradient(to bottom, #000c, transparent);
    }
    #top-controls.visible { opacity: 1; transform: translateY(0); }
    .tech-btn {
        background: #0009; border: 1px solid var(--btn-clr); color: var(--btn-clr);
        padding: 10px 24px; font-weight: 600; letter-spacing: 1.5px;
        cursor: pointer; transition: 0.2s; pointer-events: auto;
        clip-path: polygon(12px 0, 100% 0, 100% calc(100% - 12px), calc(100% - 12px) 100%, 0 100%, 0 12px);
    }
    .tech-btn:hover { background: #ffffff26; box-shadow: 0 0 15px var(--btn-clr); transform: translateY(-2px); }
    .tech-btn.active { background: var(--btn-clr); color: #000; font-weight: 800; box-shadow: 0 0 20px var(--btn-clr); }
    .btn-neon { --btn-clr: var(--c-cyan); } .btn-fire { --btn-clr: var(--c-fire); }
    .btn-matrix { --btn-clr: var(--c-matrix); } .btn-ice { --btn-clr: var(--c-ice); }
    .btn-pink { --btn-clr: var(--c-pink); }
    .divider { width: 2px; height: 24px; background: #444; margin: 0 15px; transform: skewX(-20deg); }
    .start-panel {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        text-align: center; background: var(--c-panel); border: 1px solid var(--c-cyan);
        padding: 60px 80px; backdrop-filter: blur(10px); z-index: 20;
        clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
        box-shadow: 0 0 50px #00f3ff26; transition: 0.5s;
    }
    .start-panel h1 { font-size: 3.5rem; text-shadow: 0 0 20px var(--c-cyan); letter-spacing: 8px; font-weight: 200; margin: 0 0 10px; }
    .start-panel p { color: var(--c-cyan); letter-spacing: 3px; text-transform: uppercase; margin-bottom: 40px; }
    .btn-large { padding: 18px 50px; font-size: 18px; --btn-clr: var(--c-cyan); }
    .mascot-container {
        position: absolute; bottom: 60px; left: 30px; width: 140px; cursor: grab;
        pointer-events: auto; z-index: 100; touch-action: none; transition: transform 0.1s;
    }
    .mascot-container:active { cursor: grabbing; transform: scale(0.95); }
    .mascot-container img { width: 100%; display: block; filter: drop-shadow(0 0 8px #fff6); pointer-events: none; }
    .mascot-label {
        position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
        background: #000c; border: 1px solid var(--c-cyan); color: var(--c-cyan);
        font-size: 11px; padding: 4px 12px; border-radius: 20px;
        opacity: 0; transition: 0.3s; pointer-events: none; white-space: nowrap;
    }
    .mascot-container:hover .mascot-label { opacity: 1; }
    .footer {
        text-align: center; padding: 15px 0 20px; font-size: 13px; color: #666;
        letter-spacing: 1.5px; background: linear-gradient(to top, #000 30%, transparent); pointer-events: auto;
    }
    .footer span { color: #999; font-weight: bold; }
</style>
</head>
<body>
    <div class="grid-bg"></div>
    <div id="mirror-container">
        <video id="vid" autoplay playsinline muted></video>
        <canvas id="cvs"></canvas>
    </div>
    <div id="ui-layer">
        <div id="top-controls">
            <button class="tech-btn btn-pink" id="camBtn" onclick="toggleCam()">隱藏鏡頭</button>
            <div class="divider"></div>
            <button class="tech-btn btn-neon active" onclick="setPal('neon', this)">霓虹</button>
            <button class="tech-btn btn-fire" onclick="setPal('fire', this)">火焰</button>
            <button class="tech-btn btn-matrix" onclick="setPal('matrix', this)">駭客</button>
            <button class="tech-btn btn-ice" onclick="setPal('ice', this)">冰霜</button>
        </div>
        <div class="start-panel" id="start">
            <h1>炫彩粒子互動系統</h1>
            <p>Motion Particle System</p>
            <button class="tech-btn btn-large" onclick="init()">啟動系統 START</button>
        </div>
        <div class="mascot-container" id="mascot">
            <div class="mascot-label">LiyuChillGuy</div>
            <img src="image/LiyuChillGuy.svg" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/4/47/React.svg/512px-React.svg.png'" alt="Mascot">
        </div>
        <div class="footer">Copyright © <span>Liyuchiutiger Gongminshen</span></div>
    </div>

    <script>
        const $ = id => document.getElementById(id);
        const vid = $('vid'), cvs = $('cvs'), ctx = cvs.getContext('2d', { alpha: true });
        const mCvs = document.createElement('canvas'), mCtx = mCvs.getContext('2d', { willReadFrequently: true });
        
        const CFG = {
            cw: 100, limit: 1200, thresh: 30, spawn: 3,
            pals: {
                neon: ['#00f3ff', '#bc13fe', '#ffffff'],
                fire: ['#ff5e00', '#ffae00', '#ff0000', '#220500'],
                matrix: ['#39ff14', '#008f11', '#ccffcc'],
                ice: ['#00c3ff', '#ffffff', '#0066ff']
            }
        };

        let w, h, ch = 75, parts = [], prevData = null;
        let active = false, showVid = true, curPal = CFG.pals.neon;

        class P {
            constructor(x, y) {
                this.x = x; this.y = y;
                const a = Math.random() * 6.28, s = Math.random() * 5 + 1;
                this.vx = Math.cos(a) * s; this.vy = Math.sin(a) * s;
                this.l = 1; this.d = Math.random() * 0.04 + 0.015;
                this.sz = Math.random() * 4 + 1;
                this.c = curPal[Math.floor(Math.random() * curPal.length)];
            }
            up() {
                this.x += this.vx; this.y += this.vy;
                this.vx *= 0.92; this.vy = this.vy * 0.92 + 0.15;
                this.l -= this.d; this.sz *= 0.95;
            }
            draw(c) {
                c.globalAlpha = this.l; c.fillStyle = this.c;
                c.beginPath(); c.arc(this.x, this.y, this.sz, 0, 6.28); c.fill();
            }
        }

        const resize = () => {
            w = cvs.width = window.innerWidth;
            h = cvs.height = window.innerHeight;
            if (vid.videoWidth) {
                ch = Math.floor(CFG.cw * (vid.videoHeight / vid.videoWidth));
                mCvs.width = CFG.cw; mCvs.height = ch;
            }
        };
        window.onresize = resize;

        window.setPal = (n, el) => {
            curPal = CFG.pals[n];
            document.querySelectorAll('#top-controls .tech-btn:not(#camBtn)').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
        };

        window.toggleCam = () => {
            showVid = !showVid;
            vid.style.opacity = showVid ? '1' : '0';
            const b = $('camBtn');
            b.innerText = showVid ? "隱藏鏡頭" : "顯示鏡頭";
            b.classList.toggle('active', !showVid);
        };

        window.init = async () => {
            try {
                const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user", width: 640 }, audio: false });
                vid.srcObject = s;
                vid.onloadedmetadata = () => {
                    vid.play(); active = true; resize();
                    const st = $('start');
                    st.style.transform = "translate(-50%, -60%) scale(0.9)"; st.style.opacity = 0;
                    setTimeout(() => { st.style.display = 'none'; $('top-controls').classList.add('visible'); }, 500);
                    loop();
                };
            } catch { alert("無法啟動攝影機"); }
        };

        const detect = () => {
            if (!vid.videoWidth) return;
            mCtx.drawImage(vid, 0, 0, CFG.cw, ch);
            const d = mCtx.getImageData(0, 0, CFG.cw, ch).data;
            if (!prevData) { prevData = d; return; }

            for (let i = 0; i < d.length; i += 16) {
                if (Math.abs(d[i+1] - prevData[i+1]) > CFG.thresh && parts.length < CFG.limit) {
                    const pi = i / 4, rx = (pi % CFG.cw) * (w / CFG.cw), ry = Math.floor(pi / CFG.cw) * (h / ch);
                    for (let k = 0; k < CFG.spawn; k++) parts.push(new P(rx + (Math.random() * 20 - 10), ry + (Math.random() * 20 - 10)));
                }
            }
            prevData = d;
        };

        const loop = () => {
            if (!active) return;
            showVid ? ctx.clearRect(0, 0, w, h) : (ctx.fillStyle = '#02020533', ctx.fillRect(0, 0, w, h));
            detect();
            ctx.globalCompositeOperation = showVid ? 'source-over' : 'lighter';
            for (let i = parts.length - 1; i >= 0; i--) {
                parts[i].up(); parts[i].draw(ctx);
                if (parts[i].l <= 0) parts.splice(i, 1);
            }
            ctx.globalCompositeOperation = 'source-over';
            requestAnimationFrame(loop);
        };

        const mas = $('mascot');
        let drag = false, sx, sy, ix, iy;
        const getP = e => e.touches ? e.touches[0] : e;
        const start = e => {
            if (e.target.className === 'mascot-label') return;
            e.preventDefault(); drag = true;
            const p = getP(e); sx = p.clientX; sy = p.clientY;
            const r = mas.getBoundingClientRect(); ix = r.left; iy = r.top;
            mas.style.cssText = `left:${ix}px; top:${iy}px; bottom:auto; right:auto; cursor:grabbing;`;
        };
        const move = e => {
            if (!drag) return;
            e.preventDefault(); const p = getP(e);
            mas.style.left = (ix + (p.clientX - sx)) + 'px';
            mas.style.top = (iy + (p.clientY - sy)) + 'px';
        };
        const end = () => { drag = false; mas.style.cursor = 'grab'; };

        mas.addEventListener('mousedown', start); mas.addEventListener('touchstart', start, {passive: false});
        window.addEventListener('mousemove', move); window.addEventListener('touchmove', move, {passive: false});
        window.addEventListener('mouseup', end); window.addEventListener('touchend', end);
    </script>
</body>
</html>